"use strict";
var observable_1 = require("data/observable");
var home_model_1 = require("./home-model");
var gestures_1 = require("ui/gestures");
var enums_1 = require("ui/enums");
var platform_1 = require("platform");
var builder = require("ui/builder");
var fs = require("file-system");
var dialogs = require("ui/dialogs");
var user_service_1 = require("../shared/user.service");
var page;
var settingsContainer;
var settingsOverlayContainer;
var dismissNote;
var blurView = false;
var userService;
function loaded(args) {
    page = args.object;
    userService = new user_service_1.UserService();
    settingsContainer = page.getViewById('settings_container');
    settingsOverlayContainer = page.getViewById('settings_overlay_container');
    dismissNote = page.getViewById('dismiss_note');
    var buzz = UISelectionFeedbackGenerator.new();
    settingsContainer.on(gestures_1.GestureTypes.pan, function (args) {
        //console.log("Pan deltaX:" + args.deltaX + "; deltaY:" + args.deltaY + ";");
        settingsContainer.translateY = args.deltaY;
        if (args.deltaY > 150) {
            if (dismissNote.opacity == 0) {
                buzz.selectionChanged();
                dismissNote.animate({
                    opacity: 1,
                    duration: 250
                });
            }
        }
        else {
            if (dismissNote.opacity == 1) {
                dismissNote.animate({
                    opacity: 0,
                    duration: 250
                });
            }
        }
        if (args.state == 3) {
            if (args.deltaY > 150) {
                settingsContainer.animate({
                    translate: { x: 0, y: 1000 },
                    duration: 500,
                    curve: enums_1.AnimationCurve.cubicBezier(0.1, 0.1, 0.1, 1)
                }).then(function () {
                    page.bindingContext.set('settingsShown', false);
                    settingsContainer.translateY = 0;
                    dismissNote.opacity = 0;
                });
                settingsOverlayContainer.animate({
                    opacity: 0,
                    duration: 500,
                    curve: enums_1.AnimationCurve.cubicBezier(0.1, 0.1, 0.1, 1)
                }).then(function () {
                    settingsOverlayContainer.opacity = 1;
                });
            }
            else {
                settingsContainer.animate({
                    translate: { x: 0, y: 0 },
                    duration: 200,
                    curve: enums_1.AnimationCurve.cubicBezier(0.1, 0.1, 0.1, 1)
                });
            }
        }
        console.log('pulling down ' + args.deltaY + ' points');
    });
    page.bindingContext = new home_model_1.HomeModel();
    page.bindingContext.set('editRates', function () {
        showSettings('/views/components/editrates/editrates.xml');
        page.bindingContext.set('settingsTitle', 'Edit Rates');
    });
    page.bindingContext.set('saveRates', function () {
        console.log(page.bindingContext.get('user').hourlyRate);
        console.log(page.bindingContext.get('user').overtimeRate);
    });
    page.bindingContext.set('editFamily', function (args) {
        var families = page.bindingContext.get('families');
        var family = families.filter(function (item) { return item.id === args.object.id; })[0];
        page.bindingContext.set('editingFamily', family);
        showSettings('/views/components/editfamily/editfamily.xml');
        page.bindingContext.set('settingsTitle', 'Edit Family');
        page.getViewById('family_name').text = family.get('name');
        page.getViewById('family_email').text = family.get('email');
    });
    page.bindingContext.set('addFamily', function () {
        page.bindingContext.set('editingFamily', false);
        showSettings('/views/components/editfamily/editfamily.xml');
        page.bindingContext.set('settingsTitle', 'Add Family');
    });
    page.bindingContext.set('saveFamily', function () {
        var editingFamily = page.bindingContext.get('editingFamily');
        var data = {
            name: page.getViewById('family_name').text,
            email: page.getViewById('family_email').text
        };
        if (editingFamily) {
            userService.saveFamily(editingFamily.get('id'), data).then(function (result) {
                var families = page.bindingContext.get('families');
                families.forEach(function (element) {
                    if (element.get('id') == editingFamily.get('id')) {
                        element.set('name', data.name);
                        element.set('email', data.email);
                    }
                });
                page.bindingContext.hideSettings();
            });
        }
        else {
            var families = page.bindingContext.get('families');
            userService.addFamily(data).then(function (result) {
                var families = page.bindingContext.get('families');
                data.id = result.key;
                families.push(new observable_1.Observable(data));
                page.bindingContext.set('familiesCount', families.length);
                if (families.length == 1) {
                    page.bindingContext.set('justOneFamily', true);
                }
                else {
                    page.bindingContext.set('justOneFamily', false);
                }
                page.bindingContext.hideSettings();
            });
        }
    });
    page.bindingContext.set('removeFamily', function (args) {
        console.log(args.object.id);
        var famId = args.object.id;
        dialogs.confirm('Are you sure you want to remove this family?').then(function (result) {
            if (result) {
                userService.updateFamily(famId, { deleted: true }).then(function (result) {
                    var families = page.bindingContext.get('families');
                    var deleteIndex;
                    families.forEach(function (element, index) {
                        if (element.get('id') == famId)
                            deleteIndex = index;
                    });
                    families.splice(deleteIndex, 1);
                    console.log(families.length);
                    page.bindingContext.set('families', families);
                    page.bindingContext.set('familiesCount', families.length);
                    if (families.length == 1) {
                        page.bindingContext.set('justOneFamily', true);
                    }
                    else {
                        page.bindingContext.set('justOneFamily', false);
                    }
                    page.bindingContext.hideSettings();
                });
            }
        });
    });
    page.bindingContext.set('hideSettings', function () {
        var deviceHeight = platform_1.screen.mainScreen.heightDIPs;
        settingsContainer.animate({
            translate: { x: 0, y: deviceHeight - 30 },
            duration: 300,
            curve: enums_1.AnimationCurve.cubicBezier(0.1, 0.1, 0.1, 1)
        }).then(function () {
            page.bindingContext.set('settingsShown', false);
        });
        settingsOverlayContainer.animate({
            opacity: 0,
            duration: 300
        });
    });
}
exports.loaded = loaded;
function showSettings(viewPath) {
    console.log(viewPath);
    page.bindingContext.set('settingsShown', true);
    var deviceHeight = platform_1.screen.mainScreen.heightDIPs;
    settingsContainer.translateY = deviceHeight + 30;
    settingsContainer.animate({
        translate: { x: 0, y: 0 },
        duration: 300,
        curve: enums_1.AnimationCurve.cubicBezier(0.1, 0.1, 0.1, 1)
    });
    settingsOverlayContainer.opacity = 0;
    settingsOverlayContainer.animate({
        opacity: 1,
        duration: 100
    });
    var container = page.getViewById('settings_view');
    container.removeChildren();
    var path = fs.knownFolders.currentApp().path;
    var component = builder.load(path + viewPath);
    container.addChild(component);
    var containerBounds = settingsContainer.ios.bounds;
    if (!blurView) {
        blurView = UIVisualEffectView.alloc().initWithEffect(UIBlurEffect.effectWithStyle(UIBlurEffectStyleLight));
        blurView.frame = {
            origin: { x: containerBounds.origin.x, y: containerBounds.origin.y - 20 },
            size: { width: containerBounds.size.width, height: containerBounds.size.height + 20 }
        };
        blurView.autoresizingMask = UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleHeight;
        settingsContainer.ios.addSubview(blurView);
        settingsContainer.ios.sendSubviewToBack(blurView);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG9tZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImhvbWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDhDQUF3RDtBQUV4RCwyQ0FBeUM7QUFFekMsd0NBQWdFO0FBQ2hFLGtDQUEwQztBQUUxQyxxQ0FBa0M7QUFDbEMsb0NBQXNDO0FBRXRDLGdDQUFrQztBQUNsQyxvQ0FBc0M7QUFDdEMsdURBQXFEO0FBRXJELElBQUksSUFBSSxDQUFDO0FBQ1QsSUFBSSxpQkFBOEIsQ0FBQztBQUNuQyxJQUFJLHdCQUF3QixDQUFDO0FBQzdCLElBQUksV0FBVyxDQUFDO0FBRWhCLElBQUksUUFBUSxHQUFRLEtBQUssQ0FBQztBQUMxQixJQUFJLFdBQXdCLENBQUM7QUFHN0IsZ0JBQXVCLElBQWU7SUFDbEMsSUFBSSxHQUFTLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDekIsV0FBVyxHQUFHLElBQUksMEJBQVcsRUFBRSxDQUFDO0lBQ2hDLGlCQUFpQixHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsb0JBQW9CLENBQUMsQ0FBQztJQUMzRCx3QkFBd0IsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLDRCQUE0QixDQUFDLENBQUE7SUFDekUsV0FBVyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDL0MsSUFBSSxJQUFJLEdBQUcsNEJBQTRCLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDOUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDLHVCQUFZLENBQUMsR0FBRyxFQUFFLFVBQVUsSUFBeUI7UUFDdEUsNkVBQTZFO1FBQzdFLGlCQUFpQixDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQzNDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUVwQixFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzNCLElB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RixRQUFRLENBQUMsZ0JBQWdCLEdBQUcsK0JBQStCLEdBQUcsZ0NBQWdDLENBQUM7UUFDL0YsaUJBQWlCLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMzQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdEQsQ0FBQztBQUdMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudERhdGEsIE9ic2VydmFibGUgfSBmcm9tICdkYXRhL29ic2VydmFibGUnO1xuaW1wb3J0IHsgUGFnZSB9IGZyb20gJ3VpL3BhZ2UnO1xuaW1wb3J0IHsgSG9tZU1vZGVsIH0gZnJvbSAnLi9ob21lLW1vZGVsJztcbmltcG9ydCAqIGFzIGZpcmViYXNlIGZyb20gJ25hdGl2ZXNjcmlwdC1wbHVnaW4tZmlyZWJhc2UnO1xuaW1wb3J0IHsgR2VzdHVyZVR5cGVzLCBQYW5HZXN0dXJlRXZlbnREYXRhIH0gZnJvbSBcInVpL2dlc3R1cmVzXCI7XG5pbXBvcnQgeyBBbmltYXRpb25DdXJ2ZSB9IGZyb20gXCJ1aS9lbnVtc1wiO1xuaW1wb3J0IHsgQW5pbWF0aW9uRGVmaW5pdGlvbiB9IGZyb20gXCJ1aS9hbmltYXRpb25cIjtcbmltcG9ydCB7IHNjcmVlbiB9IGZyb20gXCJwbGF0Zm9ybVwiO1xuaW1wb3J0ICogYXMgYnVpbGRlciBmcm9tICd1aS9idWlsZGVyJztcbmltcG9ydCB7IFN0YWNrTGF5b3V0IH0gZnJvbSAndWkvbGF5b3V0cy9zdGFjay1sYXlvdXQnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZmlsZS1zeXN0ZW0nO1xuaW1wb3J0ICogYXMgZGlhbG9ncyBmcm9tICd1aS9kaWFsb2dzJztcbmltcG9ydCB7IFVzZXJTZXJ2aWNlIH0gZnJvbSAnLi4vc2hhcmVkL3VzZXIuc2VydmljZSc7XG5cbmxldCBwYWdlO1xubGV0IHNldHRpbmdzQ29udGFpbmVyOiBTdGFja0xheW91dDtcbmxldCBzZXR0aW5nc092ZXJsYXlDb250YWluZXI7XG5sZXQgZGlzbWlzc05vdGU7XG5cbmxldCBibHVyVmlldzogYW55ID0gZmFsc2U7XG5sZXQgdXNlclNlcnZpY2U6IFVzZXJTZXJ2aWNlO1xuZGVjbGFyZSB2YXIgVUlCYXJTdHlsZUJsYWNrOmFueSwgVUlCYXJNZXRyaWNzRGVmYXVsdDphbnksIE5TRm9yZWdyb3VuZENvbG9yQXR0cmlidXRlTmFtZTphbnksIE5TRGljdGlvbmFyeTphbnksIFVJSW1hZ2U6YW55LCBVSUNvbG9yOmFueSwgVUlWaXN1YWxFZmZlY3RWaWV3OmFueSwgVUlCbHVyRWZmZWN0OmFueSwgVUlWaWV3QXV0b3Jlc2l6aW5nRmxleGlibGVIZWlnaHQ6YW55LCBVSVZpZXdBdXRvcmVzaXppbmdGbGV4aWJsZVdpZHRoOmFueSwgVUlCbHVyRWZmZWN0U3R5bGVMaWdodDphbnksIFVJU3RhdHVzQmFyU3R5bGU6YW55LCBVSUJsdXJFZmZlY3RTdHlsZURhcms6IGFueTtcblxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRlZChhcmdzOiBFdmVudERhdGEpIHtcbiAgICBwYWdlID0gPFBhZ2U+YXJncy5vYmplY3Q7XG4gICAgdXNlclNlcnZpY2UgPSBuZXcgVXNlclNlcnZpY2UoKTtcbiAgICBzZXR0aW5nc0NvbnRhaW5lciA9IHBhZ2UuZ2V0Vmlld0J5SWQoJ3NldHRpbmdzX2NvbnRhaW5lcicpO1xuICAgIHNldHRpbmdzT3ZlcmxheUNvbnRhaW5lciA9IHBhZ2UuZ2V0Vmlld0J5SWQoJ3NldHRpbmdzX292ZXJsYXlfY29udGFpbmVyJylcbiAgICBkaXNtaXNzTm90ZSA9IHBhZ2UuZ2V0Vmlld0J5SWQoJ2Rpc21pc3Nfbm90ZScpO1xuICAgIGxldCBidXp6ID0gVUlTZWxlY3Rpb25GZWVkYmFja0dlbmVyYXRvci5uZXcoKTtcbiAgICBzZXR0aW5nc0NvbnRhaW5lci5vbihHZXN0dXJlVHlwZXMucGFuLCBmdW5jdGlvbiAoYXJnczogUGFuR2VzdHVyZUV2ZW50RGF0YSkge1xuICAgICAgICAvL2NvbnNvbGUubG9nKFwiUGFuIGRlbHRhWDpcIiArIGFyZ3MuZGVsdGFYICsgXCI7IGRlbHRhWTpcIiArIGFyZ3MuZGVsdGFZICsgXCI7XCIpO1xuICAgICAgICBzZXR0aW5nc0NvbnRhaW5lci50cmFuc2xhdGVZID0gYXJncy5kZWx0YVk7XG4gICAgICAgIGlmIChhcmdzLmRlbHRhWSA+IDE1MCkge1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoZGlzbWlzc05vdGUub3BhY2l0eSA9PSAwKSB7XG4gICAgICAgICAgICAgICAgYnV6ei5zZWxlY3Rpb25DaGFuZ2VkKCk7XG4gICAgICAgICAgICAgICAgZGlzbWlzc05vdGUuYW5pbWF0ZSh7XG4gICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDEsXG4gICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAyNTBcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGRpc21pc3NOb3RlLm9wYWNpdHkgPT0gMSkge1xuICAgICAgICAgICAgICAgIGRpc21pc3NOb3RlLmFuaW1hdGUoe1xuICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLFxuICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogMjUwXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoYXJncy5zdGF0ZSA9PSAzKSB7XG4gICAgICAgICAgICBpZiAoYXJncy5kZWx0YVkgPiAxNTApIHtcbiAgICAgICAgICAgICAgICBzZXR0aW5nc0NvbnRhaW5lci5hbmltYXRlKDxBbmltYXRpb25EZWZpbml0aW9uPntcbiAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlOiB7eDogMCwgeTogMTAwMH0sXG4gICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiA1MDAsXG4gICAgICAgICAgICAgICAgICAgIGN1cnZlOiBBbmltYXRpb25DdXJ2ZS5jdWJpY0JlemllcigwLjEsIDAuMSwgMC4xLCAxKVxuICAgICAgICAgICAgICAgIH0pLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBwYWdlLmJpbmRpbmdDb250ZXh0LnNldCgnc2V0dGluZ3NTaG93bicsIGZhbHNlKVxuICAgICAgICAgICAgICAgICAgICBzZXR0aW5nc0NvbnRhaW5lci50cmFuc2xhdGVZID0gMDtcbiAgICAgICAgICAgICAgICAgICAgZGlzbWlzc05vdGUub3BhY2l0eSA9IDA7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICBzZXR0aW5nc092ZXJsYXlDb250YWluZXIuYW5pbWF0ZSg8QW5pbWF0aW9uRGVmaW5pdGlvbj57XG4gICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAsXG4gICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiA1MDAsXG4gICAgICAgICAgICAgICAgICAgIGN1cnZlOiBBbmltYXRpb25DdXJ2ZS5jdWJpY0JlemllcigwLjEsIDAuMSwgMC4xLCAxKVxuICAgICAgICAgICAgICAgIH0pLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBzZXR0aW5nc092ZXJsYXlDb250YWluZXIub3BhY2l0eSA9IDE7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgc2V0dGluZ3NDb250YWluZXIuYW5pbWF0ZSg8QW5pbWF0aW9uRGVmaW5pdGlvbj57XG4gICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZToge3g6IDAsIHk6IDB9LFxuICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogMjAwLFxuICAgICAgICAgICAgICAgICAgICBjdXJ2ZTogQW5pbWF0aW9uQ3VydmUuY3ViaWNCZXppZXIoMC4xLCAwLjEsIDAuMSwgMSlcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKCdwdWxsaW5nIGRvd24gJyArIGFyZ3MuZGVsdGFZICsgJyBwb2ludHMnKTtcbiAgICB9KTtcbiAgICBwYWdlLmJpbmRpbmdDb250ZXh0ID0gbmV3IEhvbWVNb2RlbCgpO1xuXG4gICAgcGFnZS5iaW5kaW5nQ29udGV4dC5zZXQoJ2VkaXRSYXRlcycsIGZ1bmN0aW9uKCkge1xuICAgICAgICBzaG93U2V0dGluZ3MoJy92aWV3cy9jb21wb25lbnRzL2VkaXRyYXRlcy9lZGl0cmF0ZXMueG1sJyk7XG4gICAgICAgIHBhZ2UuYmluZGluZ0NvbnRleHQuc2V0KCdzZXR0aW5nc1RpdGxlJywgJ0VkaXQgUmF0ZXMnKTtcbiAgICB9KVxuXG4gICAgcGFnZS5iaW5kaW5nQ29udGV4dC5zZXQoJ3NhdmVSYXRlcycsIGZ1bmN0aW9uKCkge1xuICAgICAgICBjb25zb2xlLmxvZyhwYWdlLmJpbmRpbmdDb250ZXh0LmdldCgndXNlcicpLmhvdXJseVJhdGUpO1xuICAgICAgICBjb25zb2xlLmxvZyhwYWdlLmJpbmRpbmdDb250ZXh0LmdldCgndXNlcicpLm92ZXJ0aW1lUmF0ZSk7XG4gICAgfSlcblxuICAgIHBhZ2UuYmluZGluZ0NvbnRleHQuc2V0KCdlZGl0RmFtaWx5JywgZnVuY3Rpb24oYXJncykge1xuICAgICAgICBsZXQgZmFtaWxpZXMgPSBwYWdlLmJpbmRpbmdDb250ZXh0LmdldCgnZmFtaWxpZXMnKTtcbiAgICAgICAgbGV0IGZhbWlseSA9IGZhbWlsaWVzLmZpbHRlcihpdGVtID0+IGl0ZW0uaWQgPT09IGFyZ3Mub2JqZWN0LmlkKVswXTtcbiAgICAgICAgcGFnZS5iaW5kaW5nQ29udGV4dC5zZXQoJ2VkaXRpbmdGYW1pbHknLCBmYW1pbHkpO1xuICAgICAgICBzaG93U2V0dGluZ3MoJy92aWV3cy9jb21wb25lbnRzL2VkaXRmYW1pbHkvZWRpdGZhbWlseS54bWwnKTtcbiAgICAgICAgcGFnZS5iaW5kaW5nQ29udGV4dC5zZXQoJ3NldHRpbmdzVGl0bGUnLCAnRWRpdCBGYW1pbHknKTtcbiAgICAgICAgcGFnZS5nZXRWaWV3QnlJZCgnZmFtaWx5X25hbWUnKS50ZXh0ID0gZmFtaWx5LmdldCgnbmFtZScpO1xuICAgICAgICBwYWdlLmdldFZpZXdCeUlkKCdmYW1pbHlfZW1haWwnKS50ZXh0ID0gZmFtaWx5LmdldCgnZW1haWwnKTtcbiAgICB9KVxuXG4gICAgcGFnZS5iaW5kaW5nQ29udGV4dC5zZXQoJ2FkZEZhbWlseScsIGZ1bmN0aW9uKCkge1xuICAgICAgICBwYWdlLmJpbmRpbmdDb250ZXh0LnNldCgnZWRpdGluZ0ZhbWlseScsIGZhbHNlKTtcbiAgICAgICAgc2hvd1NldHRpbmdzKCcvdmlld3MvY29tcG9uZW50cy9lZGl0ZmFtaWx5L2VkaXRmYW1pbHkueG1sJyk7XG4gICAgICAgIHBhZ2UuYmluZGluZ0NvbnRleHQuc2V0KCdzZXR0aW5nc1RpdGxlJywgJ0FkZCBGYW1pbHknKTtcbiAgICB9KVxuXG4gICAgcGFnZS5iaW5kaW5nQ29udGV4dC5zZXQoJ3NhdmVGYW1pbHknLCBmdW5jdGlvbigpIHtcbiAgICAgICAgbGV0IGVkaXRpbmdGYW1pbHkgPSBwYWdlLmJpbmRpbmdDb250ZXh0LmdldCgnZWRpdGluZ0ZhbWlseScpO1xuICAgICAgICBsZXQgZGF0YTphbnkgPSB7XG4gICAgICAgICAgICBuYW1lOiBwYWdlLmdldFZpZXdCeUlkKCdmYW1pbHlfbmFtZScpLnRleHQsXG4gICAgICAgICAgICBlbWFpbDogcGFnZS5nZXRWaWV3QnlJZCgnZmFtaWx5X2VtYWlsJykudGV4dFxuICAgICAgICB9XG4gICAgICAgIGlmIChlZGl0aW5nRmFtaWx5KSB7XG4gICAgICAgICAgICB1c2VyU2VydmljZS5zYXZlRmFtaWx5KGVkaXRpbmdGYW1pbHkuZ2V0KCdpZCcpLCBkYXRhKS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgZmFtaWxpZXMgPSBwYWdlLmJpbmRpbmdDb250ZXh0LmdldCgnZmFtaWxpZXMnKTtcbiAgICAgICAgICAgICAgICBmYW1pbGllcy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5nZXQoJ2lkJykgPT0gZWRpdGluZ0ZhbWlseS5nZXQoJ2lkJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc2V0KCduYW1lJywgZGF0YS5uYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc2V0KCdlbWFpbCcsIGRhdGEuZW1haWwpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcGFnZS5iaW5kaW5nQ29udGV4dC5oaWRlU2V0dGluZ3MoKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgZmFtaWxpZXMgPSBwYWdlLmJpbmRpbmdDb250ZXh0LmdldCgnZmFtaWxpZXMnKTtcbiAgICAgICAgICAgIHVzZXJTZXJ2aWNlLmFkZEZhbWlseShkYXRhKS50aGVuKChyZXN1bHQ6YW55KSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGZhbWlsaWVzID0gcGFnZS5iaW5kaW5nQ29udGV4dC5nZXQoJ2ZhbWlsaWVzJyk7XG4gICAgICAgICAgICAgICAgZGF0YS5pZCA9IHJlc3VsdC5rZXk7XG4gICAgICAgICAgICAgICAgZmFtaWxpZXMucHVzaChuZXcgT2JzZXJ2YWJsZShkYXRhKSk7XG4gICAgICAgICAgICAgICAgcGFnZS5iaW5kaW5nQ29udGV4dC5zZXQoJ2ZhbWlsaWVzQ291bnQnLCBmYW1pbGllcy5sZW5ndGgpO1xuICAgICAgICAgICAgICAgIGlmIChmYW1pbGllcy5sZW5ndGggPT0gMSkge1xuICAgICAgICAgICAgICAgICAgICBwYWdlLmJpbmRpbmdDb250ZXh0LnNldCgnanVzdE9uZUZhbWlseScsIHRydWUpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBhZ2UuYmluZGluZ0NvbnRleHQuc2V0KCdqdXN0T25lRmFtaWx5JywgZmFsc2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBwYWdlLmJpbmRpbmdDb250ZXh0LmhpZGVTZXR0aW5ncygpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfSAgICAgICAgXG4gICAgfSlcblxuICAgIHBhZ2UuYmluZGluZ0NvbnRleHQuc2V0KCdyZW1vdmVGYW1pbHknLCBmdW5jdGlvbihhcmdzKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGFyZ3Mub2JqZWN0LmlkKTtcbiAgICAgICAgbGV0IGZhbUlkID0gYXJncy5vYmplY3QuaWQ7XG4gICAgICAgIGRpYWxvZ3MuY29uZmlybSgnQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIHJlbW92ZSB0aGlzIGZhbWlseT8nKS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICB1c2VyU2VydmljZS51cGRhdGVGYW1pbHkoZmFtSWQsIHtkZWxldGVkOiB0cnVlfSkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBmYW1pbGllcyA9IHBhZ2UuYmluZGluZ0NvbnRleHQuZ2V0KCdmYW1pbGllcycpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgZGVsZXRlSW5kZXg7XG4gICAgICAgICAgICAgICAgICAgIGZhbWlsaWVzLmZvckVhY2goKGVsZW1lbnQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5nZXQoJ2lkJykgPT0gZmFtSWQpIGRlbGV0ZUluZGV4ID0gaW5kZXg7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBmYW1pbGllcy5zcGxpY2UoZGVsZXRlSW5kZXgsIDEpXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGZhbWlsaWVzLmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgICAgIHBhZ2UuYmluZGluZ0NvbnRleHQuc2V0KCdmYW1pbGllcycsIGZhbWlsaWVzKTtcbiAgICAgICAgICAgICAgICAgICAgcGFnZS5iaW5kaW5nQ29udGV4dC5zZXQoJ2ZhbWlsaWVzQ291bnQnLCBmYW1pbGllcy5sZW5ndGgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZmFtaWxpZXMubGVuZ3RoID09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2UuYmluZGluZ0NvbnRleHQuc2V0KCdqdXN0T25lRmFtaWx5JywgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlLmJpbmRpbmdDb250ZXh0LnNldCgnanVzdE9uZUZhbWlseScsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBwYWdlLmJpbmRpbmdDb250ZXh0LmhpZGVTZXR0aW5ncygpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgfSlcblxuICAgIHBhZ2UuYmluZGluZ0NvbnRleHQuc2V0KCdoaWRlU2V0dGluZ3MnLCBmdW5jdGlvbigpIHtcbiAgICAgICAgbGV0IGRldmljZUhlaWdodCA9IHNjcmVlbi5tYWluU2NyZWVuLmhlaWdodERJUHM7XG4gICAgICAgIHNldHRpbmdzQ29udGFpbmVyLmFuaW1hdGUoPEFuaW1hdGlvbkRlZmluaXRpb24+e1xuICAgICAgICAgICAgdHJhbnNsYXRlOiB7eDogMCwgeTogZGV2aWNlSGVpZ2h0IC0gMzB9LFxuICAgICAgICAgICAgZHVyYXRpb246IDMwMCxcbiAgICAgICAgICAgIGN1cnZlOiBBbmltYXRpb25DdXJ2ZS5jdWJpY0JlemllcigwLjEsIDAuMSwgMC4xLCAxKVxuICAgICAgICB9KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHBhZ2UuYmluZGluZ0NvbnRleHQuc2V0KCdzZXR0aW5nc1Nob3duJywgZmFsc2UpO1xuICAgICAgICB9KVxuICAgICAgICBzZXR0aW5nc092ZXJsYXlDb250YWluZXIuYW5pbWF0ZSh7XG4gICAgICAgICAgICBvcGFjaXR5OiAwLFxuICAgICAgICAgICAgZHVyYXRpb246IDMwMFxuICAgICAgICB9KVxuICAgIH0pXG59XG5cbmZ1bmN0aW9uIHNob3dTZXR0aW5ncyh2aWV3UGF0aCkge1xuICAgIGNvbnNvbGUubG9nKHZpZXdQYXRoKTtcbiAgICBwYWdlLmJpbmRpbmdDb250ZXh0LnNldCgnc2V0dGluZ3NTaG93bicsIHRydWUpO1xuICAgIGxldCBkZXZpY2VIZWlnaHQgPSBzY3JlZW4ubWFpblNjcmVlbi5oZWlnaHRESVBzO1xuICAgIHNldHRpbmdzQ29udGFpbmVyLnRyYW5zbGF0ZVkgPSBkZXZpY2VIZWlnaHQgKyAzMDtcbiAgICBzZXR0aW5nc0NvbnRhaW5lci5hbmltYXRlKDxBbmltYXRpb25EZWZpbml0aW9uPntcbiAgICAgICAgdHJhbnNsYXRlOiB7eDogMCwgeTogMH0sXG4gICAgICAgIGR1cmF0aW9uOiAzMDAsXG4gICAgICAgIGN1cnZlOiBBbmltYXRpb25DdXJ2ZS5jdWJpY0JlemllcigwLjEsIDAuMSwgMC4xLCAxKVxuICAgIH0pXG4gICAgc2V0dGluZ3NPdmVybGF5Q29udGFpbmVyLm9wYWNpdHkgPSAwO1xuICAgIHNldHRpbmdzT3ZlcmxheUNvbnRhaW5lci5hbmltYXRlKHtcbiAgICAgICAgb3BhY2l0eTogMSxcbiAgICAgICAgZHVyYXRpb246IDEwMFxuICAgIH0pXG4gICAgdmFyIGNvbnRhaW5lcjogU3RhY2tMYXlvdXQgPSBwYWdlLmdldFZpZXdCeUlkKCdzZXR0aW5nc192aWV3Jyk7XG4gICAgY29udGFpbmVyLnJlbW92ZUNoaWxkcmVuKCk7XG4gICAgbGV0IHBhdGggPSBmcy5rbm93bkZvbGRlcnMuY3VycmVudEFwcCgpLnBhdGg7XG4gICAgbGV0IGNvbXBvbmVudCA9IGJ1aWxkZXIubG9hZChwYXRoICsgdmlld1BhdGgpO1xuICAgIGNvbnRhaW5lci5hZGRDaGlsZChjb21wb25lbnQpO1xuXG4gICAgbGV0IGNvbnRhaW5lckJvdW5kcyA9IHNldHRpbmdzQ29udGFpbmVyLmlvcy5ib3VuZHM7XG4gICAgaWYgKCFibHVyVmlldykge1xuICAgICAgICBibHVyVmlldyA9IFVJVmlzdWFsRWZmZWN0Vmlldy5hbGxvYygpLmluaXRXaXRoRWZmZWN0KFVJQmx1ckVmZmVjdC5lZmZlY3RXaXRoU3R5bGUoVUlCbHVyRWZmZWN0U3R5bGVMaWdodCkpO1xuXG4gICAgICAgIGJsdXJWaWV3LmZyYW1lID0ge1xuICAgICAgICAgICAgb3JpZ2luOiB7IHg6IGNvbnRhaW5lckJvdW5kcy5vcmlnaW4ueCwgeTogY29udGFpbmVyQm91bmRzLm9yaWdpbi55IC0gMjAgfSxcbiAgICAgICAgICAgIHNpemU6IHsgd2lkdGg6IGNvbnRhaW5lckJvdW5kcy5zaXplLndpZHRoLCBoZWlnaHQ6IGNvbnRhaW5lckJvdW5kcy5zaXplLmhlaWdodCArIDIwIH1cbiAgICAgICAgfTtcbiAgICAgICAgYmx1clZpZXcuYXV0b3Jlc2l6aW5nTWFzayA9IFVJVmlld0F1dG9yZXNpemluZ0ZsZXhpYmxlV2lkdGggfCBVSVZpZXdBdXRvcmVzaXppbmdGbGV4aWJsZUhlaWdodDtcbiAgICAgICAgc2V0dGluZ3NDb250YWluZXIuaW9zLmFkZFN1YnZpZXcoYmx1clZpZXcpO1xuICAgICAgICBzZXR0aW5nc0NvbnRhaW5lci5pb3Muc2VuZFN1YnZpZXdUb0JhY2soYmx1clZpZXcpO1xuICAgIH1cbiAgICBcblxufSJdfQ==